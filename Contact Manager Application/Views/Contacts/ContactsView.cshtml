@model IEnumerable<Contact_Manager_Application.Models.Contact>

@{
    ViewData["Title"] = "Contacts";
}

<h1>Contact Manager</h1>

<form id="csvForm" enctype="multipart/form-data">
    <input type="file" id="csvFile" name="csvFile" accept=".csv" />
    <button type="submit" class="btn btn-primary">Upload CSV</button>
</form>

<hr />

<table id="contactsTable" class="table table-bordered table-striped">
    <thead>
        <tr>
            <th>Name</th>
            <th>Date of Birth</th>
            <th>Married</th>
            <th>Phone</th>
            <th>Salary</th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var contact in Model)
        {
            <tr data-id="@contact.Id">
                <td contenteditable="true" class="name">@contact.Name</td>
                <td contenteditable="true" class="dob">@contact.DateOfBirth.ToString("yyyy-MM-dd")</td>
                <td>
                    <select class="form-select married">
                        <option value="true" selected="@(contact.Married == true)">True</option>
                        <option value="false" selected="@(contact.Married == false)">False</option>
                    </select>
                </td>
                <td contenteditable="true" class="phone">@contact.Phone</td>
                <td contenteditable="true" class="salary">@contact.Salary</td>
                <td>
                    <button class="btn btn-sm btn-success saveBtn">Save</button>
                    <button class="btn btn-sm btn-danger deleteBtn">Delete</button>
                </td>
            </tr>
        }
    </tbody>
</table>

@section Scripts {
    <script>
        $(document).ready(function () {

            $('#contactsTable').DataTable();


            $("#contactsTable tbody tr").each(function () {
                const row = $(this);

                row.find(".name").data("original", row.find(".name").text());
                row.find(".dob").data("original", row.find(".dob").text());
                row.find(".married").data("original", row.find(".married").val());
                row.find(".phone").data("original", row.find(".phone").text());
                row.find(".salary").data("original", row.find(".salary").text());
            });

            $(".saveBtn").click(async function () {

                const row = $(this).closest("tr");
                const id = row.data("id");


                const oldValues = {
                    Name: row.find(".name").data("original"),
                    DateOfBirth: row.find(".dob").data("original"),
                    Married: row.find(".married").data("original"),
                    Phone: row.find(".phone").data("original"),
                    Salary: row.find(".salary").data("original")
                };

                const contact = {
                    Id: id,
                    Name: row.find(".name").text(),
                    DateOfBirth: row.find(".dob").text(),
                    Married: row.find(".married").val() === "true",
                    Phone: row.find(".phone").text(),
                    Salary: parseFloat(row.find(".salary").text())
                };

                const response = await fetch('/Contacts/Update', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(contact)
                });

                const resultText = await response.text();

                if (response.ok) {


                    row.find(".name").data("original", contact.Name);
                    row.find(".dob").data("original", contact.DateOfBirth);
                    row.find(".married").data("original", row.find(".married").val());
                    row.find(".phone").data("original", contact.Phone);
                    row.find(".salary").data("original", contact.Salary);

                    alert("Updated!");

                } else {

                    alert("Update failed:\n" + resultText);


                    row.find(".name").text(oldValues.Name);
                    row.find(".dob").text(oldValues.DateOfBirth);
                    row.find(".married").val(oldValues.Married);
                    row.find(".phone").text(oldValues.Phone);
                    row.find(".salary").text(oldValues.Salary);
                }
        });

            $(".deleteBtn").click(async function () {

                const row = $(this).closest("tr");
                const id = row.data("id");

                const response = await fetch(`/Contacts/Delete?id=${id}`, {
                    method: 'DELETE'
                });

                if (response.ok)
                    row.remove();
                else
                    alert("Delete failed");
            });

                    $("#csvForm").submit(async function (e) {

            e.preventDefault();

            const fileInput = $("#csvFile")[0];

            if (!fileInput.files.length) {
                alert("Please select a file");
                return;
            }

            const formData = new FormData();
            formData.append("file", fileInput.files[0]);

            const response = await fetch('/Contacts/UploadCsv', {
                method: 'POST',
                body: formData
            });

            const resultText = await response.text();

            if (response.ok) {
                alert("Upload successful!");
                location.reload();
            } else {
                alert("Upload failed:\n" + resultText);
            }
        });

        });
    </script>
}